<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>lume</title>
  <style>
    :root {
      --bg: #0e0e0e;
      --fg: #d4d4d4;
      --dim: #666;
      --accent: #c8a96e;
      --green: #7ab87a;
      --red: #c47a7a;
      --blue: #7aa2c8;
      --font: 'Berkeley Mono', 'Fira Code', 'JetBrains Mono', 'Courier New', monospace;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font);
      font-size: 14px;
      line-height: 1.7;
    }

    body {
      max-width: 640px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    /* header */
    .prompt {
      color: var(--dim);
      margin-bottom: 2rem;
      font-size: 13px;
    }

    .prompt span {
      color: var(--accent);
    }

    h1 {
      font-size: 1rem;
      font-weight: normal;
      color: var(--fg);
      margin-bottom: 0.25rem;
      letter-spacing: 0.05em;
    }

    .tagline {
      color: var(--dim);
      font-size: 13px;
      margin-bottom: 2rem;
    }

    /* status bar */
    .status-bar {
      border: 1px solid #222;
      padding: 0.75rem 1rem;
      margin-bottom: 2rem;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--dim);
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .status-dot.connected { background: var(--green); }
    .status-dot.active { background: var(--accent); animation: pulse 1.5s infinite; }
    .status-dot.error { background: var(--red); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .status-text {
      color: var(--dim);
      flex: 1;
    }

    .source-label {
      color: var(--accent);
      font-size: 12px;
    }

    /* section headers */
    .section-header {
      color: var(--dim);
      font-size: 12px;
      margin-bottom: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .section-header::before {
      content: '# ';
      color: #333;
    }

    /* mode selector */
    .mode-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .mode-btn {
      background: none;
      border: 1px solid #2a2a2a;
      color: var(--dim);
      font-family: var(--font);
      font-size: 13px;
      padding: 0.65rem 1rem;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
      position: relative;
    }

    .mode-btn::before {
      content: '[ ] ';
      color: #333;
    }

    .mode-btn.active {
      border-color: var(--accent);
      color: var(--fg);
      background: #1a1610;
    }

    .mode-btn.active::before {
      content: '[x] ';
      color: var(--accent);
    }

    .mode-btn:hover:not(.active) {
      border-color: #444;
      color: var(--fg);
    }

    /* audio source panel */
    #audio-panel {
      margin-bottom: 2rem;
    }

    .claim-btn {
      width: 100%;
      background: none;
      border: 1px solid #2a2a2a;
      color: var(--dim);
      font-family: var(--font);
      font-size: 13px;
      padding: 0.75rem 1rem;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s;
      margin-bottom: 0.5rem;
    }

    .claim-btn::before {
      content: '$ ';
      color: var(--dim);
    }

    .claim-btn:hover {
      border-color: var(--green);
      color: var(--fg);
    }

    .claim-btn:hover::before {
      color: var(--green);
    }

    .claim-btn.active {
      border-color: var(--green);
      color: var(--green);
      background: #0e150e;
    }

    .claim-btn.active::before {
      color: var(--green);
    }

    .claim-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* visualiser bars */
    .viz {
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 40px;
      margin-top: 0.75rem;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .viz.visible { opacity: 1; }

    .viz-bar {
      flex: 1;
      background: var(--accent);
      min-height: 2px;
      transition: height 0.05s ease-out;
      opacity: 0.7;
    }

    .viz-bar:nth-child(odd) { background: var(--accent); }
    .viz-bar:nth-child(even) { background: var(--blue); opacity: 0.5; }

    /* manual controls */
    #manual-panel {
      margin-bottom: 2rem;
    }

    .colour-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .colour-label {
      color: var(--dim);
      font-size: 13px;
      width: 3rem;
      flex-shrink: 0;
    }

    input[type="color"] {
      width: 2rem;
      height: 2rem;
      border: 1px solid #2a2a2a;
      background: none;
      cursor: pointer;
      padding: 2px;
      border-radius: 0;
    }

    input[type="range"] {
      flex: 1;
      appearance: none;
      background: #1a1a1a;
      height: 2px;
      border-radius: 0;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 10px;
      height: 10px;
      background: var(--accent);
      cursor: pointer;
      border-radius: 0;
    }

    .brightness-val {
      color: var(--dim);
      font-size: 12px;
      width: 2.5rem;
      text-align: right;
    }

    /* preset effects */
    .presets {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 2rem;
    }

    .preset-btn {
      background: none;
      border: 1px solid #2a2a2a;
      color: var(--dim);
      font-family: var(--font);
      font-size: 12px;
      padding: 0.4rem 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .preset-btn:hover, .preset-btn.active {
      border-color: var(--blue);
      color: var(--blue);
    }

    /* log */
    .log {
      border-top: 1px solid #1a1a1a;
      padding-top: 1rem;
      font-size: 12px;
      color: var(--dim);
    }

    .log-entry {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.25rem;
    }

    .log-time {
      color: #333;
      flex-shrink: 0;
    }

    .log-msg { color: var(--dim); }
    .log-msg.ok { color: var(--green); }
    .log-msg.err { color: var(--red); }
    .log-msg.info { color: var(--accent); }

    /* hidden */
    .hidden { display: none; }
  </style>
</head>
<body>

  <h1>lume</h1>
  <p class="tagline">common room light controller</p>

  <!-- connection status -->
  <div class="status-bar">
    <div class="status-dot" id="status-dot"></div>
    <span class="status-text" id="status-text">connecting...</span>
    <span class="source-label" id="source-label"></span>
  </div>

  <!-- mode selector -->
  <div class="section-header">mode</div>
  <div class="mode-row">
    <button class="mode-btn active" id="btn-audio" onclick="setMode('audio')">audio</button>
    <button class="mode-btn" id="btn-manual" onclick="setMode('manual')">manual</button>
  </div>

  <!-- audio panel -->
  <div id="audio-panel">
    <div class="section-header">audio source</div>
    <button class="claim-btn" id="claim-btn" onclick="claimSource()">
      use this phone as source
    </button>
    <div class="viz" id="viz">
      <div class="viz-bar" id="bar-0"></div>
      <div class="viz-bar" id="bar-1"></div>
      <div class="viz-bar" id="bar-2"></div>
      <div class="viz-bar" id="bar-3"></div>
      <div class="viz-bar" id="bar-4"></div>
      <div class="viz-bar" id="bar-5"></div>
      <div class="viz-bar" id="bar-6"></div>
      <div class="viz-bar" id="bar-7"></div>
      <div class="viz-bar" id="bar-8"></div>
      <div class="viz-bar" id="bar-9"></div>
      <div class="viz-bar" id="bar-10"></div>
      <div class="viz-bar" id="bar-11"></div>
    </div>
  </div>

  <!-- manual panel -->
  <div id="manual-panel" class="hidden">
    <div class="section-header">colour</div>
    <div class="colour-row">
      <span class="colour-label">rgb</span>
      <input type="color" id="colour-picker" value="#c8a96e" oninput="sendColour()">
    </div>
    <div class="colour-row">
      <span class="colour-label">bright</span>
      <input type="range" id="brightness" min="1" max="255" value="128" oninput="sendBrightness(this.value)">
      <span class="brightness-val" id="bright-val">128</span>
    </div>

    <div class="section-header" style="margin-top:1.5rem;">effects</div>
    <div class="presets">
      <button class="preset-btn" onclick="sendEffect('static')">static</button>
      <button class="preset-btn" onclick="sendEffect('breathe')">breathe</button>
      <button class="preset-btn" onclick="sendEffect('strobe')">strobe</button>
      <button class="preset-btn" onclick="sendEffect('rainbow')">rainbow</button>
      <button class="preset-btn" onclick="sendEffect('flash')">flash</button>
      <button class="preset-btn" onclick="sendEffect('off')">off</button>
    </div>
  </div>

  <!-- log -->
  <div class="log" id="log"></div>

<script>
  // ── config ─────────────────────────────────────────────────────────────
  const WS_URL = `ws://${location.hostname}:8000/ws`;
  const FFT_SIZE = 256;
  const SEND_HZ = 30;

  // ── state ───────────────────────────────────────────────────────────────
  let ws = null;
  let mode = 'audio';
  let isSource = false;
  let audioCtx = null;
  let analyser = null;
  let sendInterval = null;
  let clientId = null;
  let currentSource = null;

  // ── websocket ───────────────────────────────────────────────────────────
  function connect() {
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      setStatus('connected', 'connected');
      log('connection established', 'ok');
    };

    ws.onclose = () => {
      setStatus('error', 'disconnected — retrying...');
      log('connection lost', 'err');
      isSource = false;
      updateClaimBtn();
      setTimeout(connect, 2000);
    };

    ws.onerror = () => {
      setStatus('error', 'connection error');
    };

    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);

      if (msg.type === 'init') {
        clientId = msg.client_id;
        currentSource = msg.current_source;
        updateSourceLabel();
        log(`assigned id ${clientId.slice(0,8)}`, 'info');
      }

      if (msg.type === 'source_changed') {
        currentSource = msg.source_id;
        const mine = currentSource === clientId;
        isSource = mine;
        updateClaimBtn();
        updateSourceLabel();
        if (mine) {
          log('you are now the audio source', 'ok');
          if (mode === 'audio') startAudio();
        } else {
          log(`source: ${msg.source_id ? msg.source_id.slice(0,8) : 'none'}`, 'info');
          stopAudio();
        }
      }
    };
  }

  function send(obj) {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(obj));
    }
  }

  // ── ui state ────────────────────────────────────────────────────────────
  function setStatus(state, text) {
    const dot = document.getElementById('status-dot');
    dot.className = 'status-dot ' + state;
    document.getElementById('status-text').textContent = text;
  }

  function updateClaimBtn() {
    const btn = document.getElementById('claim-btn');
    if (isSource) {
      btn.textContent = 'this phone is the source';
      btn.classList.add('active');
    } else {
      btn.textContent = 'use this phone as source';
      btn.classList.remove('active');
    }
  }

  function updateSourceLabel() {
    const label = document.getElementById('source-label');
    if (currentSource) {
      label.textContent = currentSource === clientId
        ? '● you'
        : `● ${currentSource.slice(0,8)}`;
    } else {
      label.textContent = '';
    }
  }

  function setMode(m) {
    mode = m;
    document.getElementById('btn-audio').classList.toggle('active', m === 'audio');
    document.getElementById('btn-manual').classList.toggle('active', m === 'manual');
    document.getElementById('audio-panel').classList.toggle('hidden', m !== 'audio');
    document.getElementById('manual-panel').classList.toggle('hidden', m !== 'manual');

    if (m === 'audio' && isSource) startAudio();
    if (m === 'manual') stopAudio();
  }

  // ── audio analysis ──────────────────────────────────────────────────────
  async function claimSource() {
    if (isSource) return;
    send({ type: 'claim_source' });
  }

  async function startAudio() {
    if (audioCtx) return;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      audioCtx = new AudioContext();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = FFT_SIZE;
      analyser.smoothingTimeConstant = 0.75;
      const source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);

      document.getElementById('viz').classList.add('visible');

      sendInterval = setInterval(() => {
        if (!isSource || mode !== 'audio') return;

        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(data);

        const third = Math.floor(data.length / 3);
        const avg = (arr) => arr.reduce((a, b) => a + b, 0) / arr.length / 255;

        const bass = avg(data.slice(0, third));
        const mid  = avg(data.slice(third, third * 2));
        const treble = avg(data.slice(third * 2));

        send({ type: 'freq', bass, mid, treble });
        updateViz(data);
      }, 1000 / SEND_HZ);

      log('microphone active', 'ok');
      setStatus('active', 'listening');

    } catch (err) {
      log('microphone permission denied', 'err');
    }
  }

  function stopAudio() {
    if (sendInterval) { clearInterval(sendInterval); sendInterval = null; }
    if (audioCtx) { audioCtx.close(); audioCtx = null; analyser = null; }
    document.getElementById('viz').classList.remove('visible');
    setStatus('connected', 'connected');
  }

  function updateViz(data) {
    const bars = 12;
    const step = Math.floor(data.length / bars);
    for (let i = 0; i < bars; i++) {
      const val = data[i * step] / 255;
      const el = document.getElementById(`bar-${i}`);
      if (el) el.style.height = Math.max(2, val * 40) + 'px';
    }
  }

  // ── manual controls ─────────────────────────────────────────────────────
  function sendColour() {
    const hex = document.getElementById('colour-picker').value;
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    send({ type: 'colour', r, g, b });
  }

  function sendBrightness(val) {
    document.getElementById('bright-val').textContent = val;
    send({ type: 'brightness', value: parseInt(val) });
  }

  function sendEffect(name) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    send({ type: 'effect', name });
  }

  // ── log ──────────────────────────────────────────────────────────────────
  function log(msg, cls = '') {
    const el = document.getElementById('log');
    const now = new Date().toTimeString().slice(0,8);
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `<span class="log-time">${now}</span><span class="log-msg ${cls}">${msg}</span>`;
    el.prepend(entry);
    if (el.children.length > 8) el.removeChild(el.lastChild);
  }

  // ── init ─────────────────────────────────────────────────────────────────
  connect();
</script>
</body>
</html>
